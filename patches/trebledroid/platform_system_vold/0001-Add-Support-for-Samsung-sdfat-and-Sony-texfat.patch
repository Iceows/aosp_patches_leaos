From a6d2dc3ba9de258c3e873b1f5a8fc401fbda72a9 Mon Sep 17 00:00:00 2001
From: Raphael Mounier <mounierr07@gmail.com>
Date: Fri, 7 Oct 2022 06:22:31 +0200
Subject: [PATCH 1/5] Add Support for Samsung sdfat and Sony texfat

Add Support for Samsung sdfat and Sony texfat
---
 fs/Exfat.cpp | 18 ++++++++++++------
 1 file changed, 12 insertions(+), 6 deletions(-)

diff --git a/fs/Exfat.cpp b/fs/Exfat.cpp
index c8b19e0..e38ca21 100644
--- a/fs/Exfat.cpp
+++ b/fs/Exfat.cpp
@@ -34,17 +34,20 @@ static const char* kMkfsPath = "/system/bin/mkfs.exfat";
 static const char* kFsckPath = "/system/bin/fsck.exfat";
 
 bool IsSupported() {
-    return access(kMkfsPath, X_OK) == 0 && access(kFsckPath, X_OK) == 0 &&
-           IsFilesystemSupported("exfat");
+    return (access(kMkfsPath, X_OK) == 0) && 
+           (access(kFsckPath, X_OK) == 0) &&
+           (IsFilesystemSupported("exfat") ||
+           IsFilesystemSupported("sdfat") ||
+           IsFilesystemSupported("texfat"));
 }
 
 status_t Check(const std::string& source) {
     std::vector<std::string> cmd;
     cmd.push_back(kFsckPath);
-    cmd.push_back("-y");
+    cmd.push_back("-a");
     cmd.push_back(source);
 
-    int rc = ForkExecvpTimeout(cmd, kUntrustedFsckSleepTime, sFsckUntrustedContext);
+    int rc = ForkExecvp(cmd, nullptr, sFsckUntrustedContext);
     if (rc == 0) {
         LOG(INFO) << "Check OK";
         return 0;
@@ -61,13 +64,16 @@ status_t Mount(const std::string& source, const std::string& target, int ownerUi
     auto mountData = android::base::StringPrintf("uid=%d,gid=%d,fmask=%o,dmask=%o", ownerUid,
                                                  ownerGid, permMask, permMask);
 
-    if (mount(source.c_str(), target.c_str(), "exfat", mountFlags, mountData.c_str()) == 0) {
+    const char *fs = "exfat";
+    if (IsFilesystemSupported("texfat")) fs = "texfat";
+    if (IsFilesystemSupported("sdfat")) fs = "sdfat";
+    if (mount(source.c_str(), target.c_str(), fs, mountFlags, mountData.c_str()) == 0) {
         return 0;
     }
 
     PLOG(ERROR) << "Mount failed; attempting read-only";
     mountFlags |= MS_RDONLY;
-    if (mount(source.c_str(), target.c_str(), "exfat", mountFlags, mountData.c_str()) == 0) {
+    if (mount(source.c_str(), target.c_str(), fs, mountFlags, mountData.c_str()) == 0) {
         return 0;
     }
 
-- 
2.25.1

