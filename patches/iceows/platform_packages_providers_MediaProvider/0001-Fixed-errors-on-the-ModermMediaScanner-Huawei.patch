From 031d6ee622531f598e6cb89c01d6a8c48843d8b9 Mon Sep 17 00:00:00 2001
From: Raphael Mounier <mounierr07@gmail.com>
Date: Wed, 20 Jul 2022 11:28:54 +0200
Subject: [PATCH] Fixed errors on the ModermMediaScanner (Huawei)

This patch prevents the media scanner from crashing when starting the phone. This problem prevented displaying the default sounds (alarm, ringtones..). The root cause of the error is a null volume name for system
---
 .../media/scan/ModernMediaScanner.java        | 19 +++++++++++++++----
 1 file changed, 15 insertions(+), 4 deletions(-)

diff --git a/src/com/android/providers/media/scan/ModernMediaScanner.java b/src/com/android/providers/media/scan/ModernMediaScanner.java
index 8927bfa..c2ee0a5 100644
--- a/src/com/android/providers/media/scan/ModernMediaScanner.java
+++ b/src/com/android/providers/media/scan/ModernMediaScanner.java
@@ -367,11 +367,22 @@ public class ModernMediaScanner implements MediaScanner {
             mRoot = root;
             mReason = reason;
 
-            if (FileUtils.contains(Environment.getStorageDirectory(), root)) {
-                mVolume = MediaVolume.fromStorageVolume(FileUtils.getStorageVolume(mContext, root));
-            } else {
+            MediaVolume VolumeTmp=null;
+             if (FileUtils.contains(Environment.getStorageDirectory(), root)) {
+                try {
+                    VolumeTmp = MediaVolume.fromStorageVolume(FileUtils.getStorageVolume(mContext, root));
+                }
+                catch (FileNotFoundException e)
+                {
+                    Log.w(TAG,"Can't find volume for " + root);
+                }
+             }
+
+            if (VolumeTmp == null)
                 mVolume = MediaVolume.fromInternal();
-            }
+            else
+                mVolume=VolumeTmp;
+
             mVolumeName = mVolume.getName();
             mFilesUri = MediaStore.Files.getContentUri(mVolumeName);
             mSignal = new CancellationSignal();
-- 
2.30.2

