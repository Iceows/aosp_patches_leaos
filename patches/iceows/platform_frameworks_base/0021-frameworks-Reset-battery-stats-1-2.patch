From 4f1d67dd342f3c12e7ac310c42ec700c586c79f9 Mon Sep 17 00:00:00 2001
From: Raphael Mounier <mounierr07@gmail.com>
Date: Tue, 20 Dec 2022 07:00:05 +0100
Subject: [PATCH] frameworks: Reset battery stats [1/2]

from

https://github.com/SuperiorOS/android_frameworks_base/commit/4785074d7a34eb9d94be853da878dfecbc279ea7
---
 core/java/android/os/BatteryManager.java                  | 8 ++++++++
 core/java/com/android/internal/app/IBatteryStats.aidl     | 3 +++
 core/res/AndroidManifest.xml                              | 5 +++++
 data/etc/privapp-permissions-platform.xml                 | 4 ++++
 .../java/com/android/server/am/BatteryStatsService.java   | 8 ++++++++
 5 files changed, 28 insertions(+)

diff --git a/core/java/android/os/BatteryManager.java b/core/java/android/os/BatteryManager.java
index 76f857bd91b7..1f7351773116 100644
--- a/core/java/android/os/BatteryManager.java
+++ b/core/java/android/os/BatteryManager.java
@@ -401,4 +401,12 @@ public class BatteryManager {
             throw e.rethrowFromSystemServer();
         }
     }
+
+    public void resetStatistics() {
+        try {
+            mBatteryStats.resetStatistics();
+        } catch (RemoteException e) {
+            throw e.rethrowFromSystemServer();
+        }
+    }
 }
diff --git a/core/java/com/android/internal/app/IBatteryStats.aidl b/core/java/com/android/internal/app/IBatteryStats.aidl
index 629a1b36b9e6..a419e349b3e1 100644
--- a/core/java/com/android/internal/app/IBatteryStats.aidl
+++ b/core/java/com/android/internal/app/IBatteryStats.aidl
@@ -189,4 +189,7 @@ interface IBatteryStats {
     void resetBattery(boolean forceUpdate);
     /** Exposed as a test API. */
     void suspendBatteryInput();
+
+    /** @hide **/
+    void resetStatistics();
 }
diff --git a/core/res/AndroidManifest.xml b/core/res/AndroidManifest.xml
index 5ae133bbe6e6..4bd55132144b 100644
--- a/core/res/AndroidManifest.xml
+++ b/core/res/AndroidManifest.xml
@@ -5292,6 +5292,11 @@
     <permission android:name="android.permission.REGISTER_STATS_PULL_ATOM"
                 android:protectionLevel="signature|privileged" />
 
+    <!-- @hide Allows an application to reset the device battery statistics -->
+    <permission android:name="android.permission.RESET_BATTERY_STATS"
+        android:permissionGroup="android.permission-group.SYSTEM_TOOLS"
+        android:protectionLevel="signature|system|development" />
+
     <!-- @SystemApi Allows an application to control the backup and restore process.
     <p>Not for use by third-party applications.
          @hide pending API council -->
diff --git a/data/etc/privapp-permissions-platform.xml b/data/etc/privapp-permissions-platform.xml
index 58a2073981bf..591e7ba29664 100644
--- a/data/etc/privapp-permissions-platform.xml
+++ b/data/etc/privapp-permissions-platform.xml
@@ -225,6 +225,10 @@ applications that come with the platform
         <permission name="android.permission.SUBSTITUTE_NOTIFICATION_APP_NAME"/>
     </privapp-permissions>
 
+    <privapp-permissions package="com.android.settings">
+        <permission name="android.permission.RESET_BATTERY_STATS"/>
+    </privapp-permissions>
+
     <privapp-permissions package="com.android.sharedstoragebackup">
         <permission name="android.permission.WRITE_MEDIA_STORAGE"/>
         <permission name="android.permission.MANAGE_EXTERNAL_STORAGE"/>
diff --git a/services/core/java/com/android/server/am/BatteryStatsService.java b/services/core/java/com/android/server/am/BatteryStatsService.java
index 606a09cb1cac..81cba1c86219 100644
--- a/services/core/java/com/android/server/am/BatteryStatsService.java
+++ b/services/core/java/com/android/server/am/BatteryStatsService.java
@@ -850,6 +850,14 @@ public final class BatteryStatsService extends IBatteryStats.Stub
         }
     }
 
+    public void resetStatistics() {
+        mContext.enforceCallingPermission(
+                android.Manifest.permission.RESET_BATTERY_STATS, null);
+        synchronized (mStats) {
+            mStats.resetAllStatsCmdLocked();
+        }
+    }
+
     public long computeBatteryTimeRemaining() {
         synchronized (mStats) {
             long time = mStats.computeBatteryTimeRemaining(SystemClock.elapsedRealtime());
-- 
2.25.1

