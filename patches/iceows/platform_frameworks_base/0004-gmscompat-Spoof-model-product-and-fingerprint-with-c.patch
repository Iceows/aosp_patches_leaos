From a5f47313c774a9e75cf5e9d735c5ab4b49dfaf51 Mon Sep 17 00:00:00 2001
From: Raphael Mounier <mounierr07@gmail.com>
Date: Fri, 14 Apr 2023 12:53:52 +0200
Subject: [PATCH] gmscompat: Spoof model, product and fingerprint with cust 
 prop

Allows you to change the product, the model and the fingerprint during the Safetynet certification

use severals properties : persist.sys.phh.safetyspoof, persist.sys.phh.safetyspoof.model, etc...

Change-Id: I5a63f4a8ba7043f3ca9ab25ec05f1d9c6d04747f
---
 .../internal/gmscompat/AttestationHooks.java  | 24 ++++++++++++-------
 1 file changed, 16 insertions(+), 8 deletions(-)

diff --git a/core/java/com/android/internal/gmscompat/AttestationHooks.java b/core/java/com/android/internal/gmscompat/AttestationHooks.java
index 2e2c6fd54d44..89987eaa55f1 100644
--- a/core/java/com/android/internal/gmscompat/AttestationHooks.java
+++ b/core/java/com/android/internal/gmscompat/AttestationHooks.java
@@ -28,8 +28,16 @@ import java.util.Arrays;
 /** @hide */
 public final class AttestationHooks {
 
-    private static final boolean PRODUCT_NEEDS_MODEL_EDIT =
+    private static final boolean SAFETYSPOOF_ENABLE =
             android.os.SystemProperties.getBoolean("persist.sys.phh.safetyspoof", false);
+    private static final String SAFETYSPOOF_MODEL =
+            android.os.SystemProperties.get("persist.sys.phh.safetyspoof.model", "Pixel XL");
+    private static final String SAFETYSPOOF_DEVICE =
+            android.os.SystemProperties.get("persist.sys.phh.safetyspoof.device", "marlin");
+    private static final String SAFETYSPOOF_PRODUCT =
+            android.os.SystemProperties.get("persist.sys.phh.safetyspoof.product", "marlin");
+    private static final String SAFETYSPOOF_FINGERPRINT=
+            android.os.SystemProperties.get("persist.sys.phh.safetyspoof.fingerprint", "google/marlin/marlin:7.1.2/NJH47F/4146041:user/release-keys");
 
     private static final String TAG = "GmsCompat/Attestation";
 
@@ -75,13 +83,13 @@ public final class AttestationHooks {
     }
 
     private static void spoofBuildGms() {
-        if (PRODUCT_NEEDS_MODEL_EDIT) {
-		// Alter model name and fingerprint to avoid hardware attestation enforcement
-		setBuildField("FINGERPRINT", "google/marlin/marlin:7.1.2/NJH47F/4146041:user/release-keys");
-		setBuildField("PRODUCT", "marlin");
-		setBuildField("DEVICE", "marlin");
-		setBuildField("MODEL", "Pixel XL");
-		setVersionField("DEVICE_INITIAL_SDK_INT", Build.VERSION_CODES.N_MR1);
+        if (SAFETYSPOOF_ENABLE) {
+            // Alter model name and fingerprint to avoid hardware attestation enforcement
+            setBuildField("FINGERPRINT", SAFETYSPOOF_FINGERPRINT);
+            setBuildField("PRODUCT", SAFETYSPOOF_PRODUCT);
+            setBuildField("DEVICE", SAFETYSPOOF_DEVICE);
+            setBuildField("MODEL", SAFETYSPOOF_MODEL);
+            setVersionField("DEVICE_INITIAL_SDK_INT", Build.VERSION_CODES.N_MR1);
         }
     }
 
-- 
2.25.1

