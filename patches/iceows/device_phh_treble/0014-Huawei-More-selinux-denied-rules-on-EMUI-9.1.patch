From 460ea52fd2dd18015a1f659e9940e14a08b4ee3d Mon Sep 17 00:00:00 2001
From: Raphael Mounier <mounierr07@gmail.com>
Date: Sun, 16 Apr 2023 12:44:44 +0200
Subject: [PATCH 2/2] Huawei - More selinux denied rules on EMUI 9.1

phh , modem and  vold rules
---
 sepolicy/huawei.te | 32 +++++++++++++++++++-------------
 sepolicy/phh.te    |  4 ++++
 sepolicy/vold.te   |  4 ++++
 3 files changed, 27 insertions(+), 13 deletions(-)

diff --git a/sepolicy/huawei.te b/sepolicy/huawei.te
index 077033a..4cabd78 100644
--- a/sepolicy/huawei.te
+++ b/sepolicy/huawei.te
@@ -55,12 +55,19 @@ allow rild splash2_data_file:file rw_file_perms;
 allow kernel splash2_data_file:dir { rw_dir_perms create setattr rmdir };
 allow kernel splash2_data_file:file { rw_file_perms create unlink setattr };
 
-# Add support off modem Huawei logging
+# Add support off modem Huawei firmware and nv file
 type mnt_modem_file, file_type;  
 type modem_log_file, file_type;
+type modem_secure_file, file_type;
+type modem_fw_file, file_type;
+type modem_nv_file, file_type;
 
 allow fsck mnt_modem_file:dir r_dir_perms;
 allow fsck modem_log_file:dir r_dir_perms;
+allow fsck modem_secure_file:dir r_dir_perms;
+allow fsck modem_fw_file:dir r_dir_perms;
+allow fsck modem_nv_file:dir r_dir_perms;
+
 allow gmscore_app mnt_modem_file:dir r_dir_perms;
 
 # Fix CPU gouvernor (rules are in xml file)
@@ -167,6 +174,9 @@ allowxperm phhsu_daemon device:blk_file ioctl {
 allow shell self:netlink_kobject_uevent_socket { create setopt getopt bind read };
 allow init self:netlink_kobject_uevent_socket { create setopt getopt bind read };
 
+
+allow priv_app metadata_file:dir { read };
+
 # DRM
 type hal_drm_widevine, domain;
 allow hal_drm_widevine shell_data_file:dir { search };
@@ -193,10 +203,15 @@ type hal_camera_default, domain;
 type hal_audio_default, domain;
 type hal_keymaster_default, domain;
 type hal_nfc_default, domain;
-
+type hi110x_daemon, domain;
+type wpa_hisi, domain;
+type aptouch_daemon, domain;
+type gpsdaemon, domain;
+type atcmdserver, domain;
+type hisecd, domain;
+type storage_info, domain;
 
 get_prop(system_app, cameradaemon_prop)
-
 get_prop(rild, config_prop)
 get_prop(rild, system_prop)
 get_prop(hal_health_default, default_prop)
@@ -210,19 +225,10 @@ get_prop(hal_audio_default, system_prop)
 get_prop(hal_keymaster_default, config_prop)
 get_prop(hal_drm_widevine, default_prop)
 get_prop(hal_nfc_default, system_prop)
-
-type hi110x_daemon, domain;
-type wpa_hisi, domain;
-type aptouch_daemon, domain;
-type gpsdaemon, domain;
-type atcmdserver, domain;
-
-type hisecd, domain;
-type storage_info, domain;
-
 get_prop(hi110x_daemon, default_prop)
 get_prop(wpa_hisi, default_prop)
 get_prop(wpa_hisi, config_prop)
+get_prop(wpa_hisi, system_prop)
 get_prop(aptouch_daemon, system_prop)
 get_prop(gpsdaemon, default_prop)
 get_prop(oeminfo_nvm, default_prop)
diff --git a/sepolicy/phh.te b/sepolicy/phh.te
index 9e233c3..c4ae324 100644
--- a/sepolicy/phh.te
+++ b/sepolicy/phh.te
@@ -15,3 +15,7 @@ allow phhsu_daemon userdata_block_device:blk_file ioctl;
 allowxperm phhsu_daemon userdata_block_device:blk_file ioctl { 0x1278 0x127a };
 
 allow kernel gsi_data_file:file rw_file_perms;
+
+allow phhsu_daemon self:capability { fsetid };
+allow phhsu_daemon kernel:system { syslog_console };
+allow phhsu_daemon dmd_device:chr_file { setattr };
diff --git a/sepolicy/vold.te b/sepolicy/vold.te
index 24ed13d..35b69e9 100644
--- a/sepolicy/vold.te
+++ b/sepolicy/vold.te
@@ -3,3 +3,7 @@ hal_client_domain(vold, hal_bootctl)
 
 allow vold system_data_file:lnk_file { unlink };
 allow mediaextractor sdcard_type:file read;
+
+allow vold block_device:blk_file { read open write ioctl};
+allow vold splash2_data_file:dir { rw_dir_perms };
+allow vold teecd_data_file:dir { rw_dir_perms };
-- 
2.25.1

