From cc232293f6e0c5af8395a70b7818b4ddfddec1f7 Mon Sep 17 00:00:00 2001
From: Raphael Mounier <mounierr07@gmail.com>
Date: Mon, 10 Apr 2023 20:08:02 +0200
Subject: [PATCH] Add several new functions from eremitein update

Add netflx bsp rev
Add secure.sh script
---
 base.mk      |  1 +
 rw-system.sh | 61 +++++++++++++++++++++++++++++++++++++++++++++++++++-
 2 files changed, 61 insertions(+), 1 deletion(-)

diff --git a/base.mk b/base.mk
index ed07565..ef61dcc 100644
--- a/base.mk
+++ b/base.mk
@@ -87,6 +87,7 @@ PRODUCT_COPY_FILES += \
 	device/phh/treble/rw-system.sh:system/bin/rw-system.sh \
 	device/phh/treble/phh-on-data.sh:system/bin/phh-on-data.sh \
 	device/phh/treble/phh-prop-handler.sh:system/bin/phh-prop-handler.sh \
+	device/phh/treble/secure.sh:system/phh/secure.sh \
 	device/phh/treble/fixSPL/getSPL.arm:system/bin/getSPL
 
 PRODUCT_COPY_FILES += \
diff --git a/rw-system.sh b/rw-system.sh
index 567886e..391cd64 100644
--- a/rw-system.sh
+++ b/rw-system.sh
@@ -60,7 +60,17 @@ if [ "$vndk" = 26 ];then
 fi
 
 setprop sys.usb.ffs.aio_compat true
+setprop persist.adb.nonblocking_ffs false
 
+# Redmi Note 9S/Pro/Max props
+if getprop ro.vendor.build.fingerprint |grep -qi -e redmi/curtana -e redmi/joyeuse -e redmi/excalibur; then
+    setprop ro.surface_flinger.has_HDR_display true
+    setprop ro.surface_flinger.has_wide_color_display true
+    setprop persist.device_config.runtime_native.usap_pool_enabled true
+    setprop debug.sf.latch_unsignaled 1
+    setprop debug.sf.enable_gl_backpressure 1
+fi
+    
 if getprop ro.vendor.build.fingerprint | grep -q -i -e Blackview/BV9500Plus;then
     setprop persist.adb.nonblocking_ffs true
 else
@@ -436,6 +446,21 @@ if getprop ro.vendor.build.fingerprint | grep -q -i \
     setprop persist.sys.qcom-brightness "$(cat /sys/class/leds/lcd-backlight/max_brightness)"
 fi
 
+#Xiaomi Redmi Note 9, Redmi 9 (Prime)
+if getprop ro.vendor.build.fingerprint |grep -qi -e Redmi/merlin -e Redmi/lancelot -e Redmi/angelican -e Redmi/dandelion; then
+    setprop persist.sys.overlay.devinputjack true
+fi
+
+# UMIDIGI A3X & A9
+if getprop ro.vendor.build.fingerprint |grep -qi -e UMIDIGI/A3X -e UMIDIGI/A9; then
+    setprop persist.sys.overlay.devinputjack true
+fi
+
+# CUBOT KINGKONG MINI2
+if getprop ro.vendor.build.fingerprint |grep -qi -e CUBOT/KINGKONG_MINI2; then
+    setprop persist.sys.overlay.devinputjack true
+fi
+
 #Realme 6
 if getprop ro.vendor.product.device |grep -iq -e RMX2001 -e RMX2151 -e RMX2111 -e RMX2111L1;then
     setprop persist.sys.phh.fingerprint.nocleanup true
@@ -629,6 +654,7 @@ if getprop ro.vendor.build.fingerprint | grep -qE -e ".*(crown|star)[q2]*lte.*"
     done
 fi
 
+
 # This matches both Razer Phone 1 & 2
 if getprop ro.vendor.build.fingerprint |grep -qE razer/cheryl;then
 	setprop ro.audio.monitorRotation true
@@ -657,6 +683,10 @@ if [ $(find /vendor/etc/audio -type f |wc -l) -le 3 ];then
 	mount -o bind /mnt/phh/empty_dir /vendor/etc/audio || true
 fi
 
+if ! grep android.hardware.ir /vendor/manifest.xml;then
+    mount -o bind system/phh/empty /system/etc/permissions/android.hardware.consumerir.xml
+fi
+
 for f in /vendor/lib{,64}/hw/com.qti.chi.override.so /vendor/lib{,64}/libVD*;do
     [ ! -f $f ] && continue
     # shellcheck disable=SC2010
@@ -714,6 +744,10 @@ if getprop ro.vendor.build.fingerprint | grep -qiE '^samsung/' && [ "$vndk" -ge
     fi
 fi
 
+if getprop ro.vendor.build.fingerprint | grep -q -e Sony/aosp_f5121/suzu; then
+    chown system:system /sys/class/leds/*/breath
+fi
+
 # For Nubia Red Magic 6 audio policy configuration
 if getprop ro.vendor.build.fingerprint | grep -q -e nubia/NX669; then
     umount /vendor/etc/audio
@@ -736,7 +770,8 @@ copyprop() {
         resetprop_phh "$1" "$(getprop "$2")"
     fi
 }
-if [ -f /system/phh/secure ] || [ -f /metadata/phh/secure ];then
+
+if [ -f /system/phh/secure ] || [ -f /metadata/phh/secure ] || [ -f /data/adb/phh/secure ];then
     copyprop ro.build.device ro.vendor.build.device
     copyprop ro.system.build.fingerprint ro.vendor.build.fingerprint
     copyprop ro.bootimage.build.fingerprint ro.vendor.build.fingerprint
@@ -762,6 +797,7 @@ if [ -f /system/phh/secure ] || [ -f /metadata/phh/secure ];then
     copyprop ro.product.manufacturer ro.vendor.product.manufacturer
     copyprop ro.system.product.manufacturer ro.product.vendor.manufacturer
     copyprop ro.product.manufacturer ro.product.vendor.manufacturer
+
     (getprop ro.vendor.build.security_patch; getprop ro.keymaster.xxx.security_patch) |sort |tail -n 1 |while read v;do
         [ -n "$v" ] && resetprop_phh ro.build.version.security_patch "$v"
     done
@@ -797,6 +833,17 @@ else
     mount -o bind /mnt/phh/xbin /system/xbin
 fi
 
+# Fix the google hotword detection for android 11 on redmi note 9s
+if getprop ro.vendor.build.fingerprint |grep -qi -e redmi/curtana; then
+     resetprop_phh ro.product.model "Note 9S"
+fi
+if getprop ro.vendor.build.fingerprint |grep -qi -e redmi/joyeuse; then
+     resetprop_phh ro.product.model "Note 9S Pro"
+fi
+if getprop ro.vendor.build.fingerprint |grep -qi -e redmi/excalibur; then
+     resetprop_phh ro.product.model "Note 9S Pro Max"
+fi
+
 for abi in "" 64;do
     f=/vendor/lib$abi/libstagefright_foundation.so
     if [ -f "$f" ];then
@@ -989,14 +1036,26 @@ resetprop_phh ro.bluetooth.library_name libbluetooth.so
 
 board="$(getprop ro.board.platform)"
 
+if getprop ro.vendor.build.fingerprint |grep -iq xiaomi/cepheus;then
+	setprop ro.netflix.bsp_rev Q855-16947-1
+fi
+    
 if [ "$board" = atoll ] || [ "$board" = sm6250 ]; then
 	setprop ro.netflix.bsp_rev Q6250-19132-1
 fi
 
+if getprop ro.vendor.build.fingerprint |grep -qi redmi/curtana -e redmi/joyeuse -e redmi/excalibur; then
+	setprop ro.netflix.bsp_rev Q6250-19132-1
+fi
+
 if [ "$board" = msmnile ]; then
 	setprop ro.netflix.bsp_rev Q855-16947-1
 fi
 
+if getprop ro.vendor.build.fingerprint |grep -iq xiaomi/renoir;then
+	setprop ro.netflix.bsp_rev Q875-32774-1
+fi
+
 if [ "$board" = sm6150 ]; then
 	setprop ro.netflix.bsp_rev Q6150-17263-1
 fi
-- 
2.25.1

